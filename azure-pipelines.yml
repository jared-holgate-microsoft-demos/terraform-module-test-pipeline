trigger:
- main

resources:
  repositories:
    - repository: terraform_module #This is the name you will reference in the checkout step
      type: github
      endpoint: jared-holgate-microsoft-demos #This is the name of the Service Connection (see: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/resources?view=azure-devops&tabs=schema#define-a-repositories-resource)
      name: jared-holgate-microsoft-demos/terraform-module-test-module #This is the name of the repo with the org specified

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self
  persistCredentials: true #This is required to keep the github git token in the config
  path: s

- checkout: terraform_module
  path: temp/module

- pwsh: |
    $repository = "$(Build.Repository.Uri)"
    $organisation = $repository -replace '/[^/]+$'
    
    $token = git config --get http.$repository.extraheader

    git config --global http.https://github.com.extraheader $token
  displayName: 'Get Config Pipeline'

- script: terraform init
  displayName: 'Terraform Init'
  env:
    TF_LOG: TRACE

- script: terraform apply -auto-approve
  displayName: 'Terrafrom Apply'
